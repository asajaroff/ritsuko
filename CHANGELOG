# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

## [Unreleased]

### Added

- **AI command for Claude API integration** (`src/commands.py`, `src/bot.py`, `src/requirements.txt`)
  - New `ai` command that allows users to interact with Claude AI (Sonnet 4.5)
  - Command accepts a prompt and returns AI-generated responses
  - Implemented in `handle_ai()` function with comprehensive error handling
  - Features:
    - Validates ANTHROPIC_API_KEY environment variable is configured
    - Accepts multi-word prompts (e.g., `ai What is Kubernetes?`)
    - Automatic progress notification: sends "Processing your request..." message if API call takes longer than 5 seconds
    - Works in both private messages and stream channels
    - Proper error messages for missing API key, empty responses, and API errors
  - Uses threading.Timer for non-blocking 5-second progress updates
  - Logs request completion time for performance monitoring
  - Model configuration: Uses `claude-sonnet-4-5-20250929` with 4096 max tokens
  - Modified `bot.py` to pass `send_message` callback to `handle_ai()` for progress updates
  - Updated help command to show AI command as available

- **Anthropic Python SDK dependency** (`src/requirements.txt`)
  - Added `anthropic==0.40.0` to requirements
  - Includes dependencies: anyio, httpx, jiter, pydantic, sniffio

- **Comprehensive unit tests for AI command** (`tests/test_bot.py`)
  - `test_handle_ai_no_anthropic_key` - Tests behavior when ANTHROPIC_API_KEY is not set
  - `test_handle_ai_no_args` - Tests AI command without arguments
  - `test_handle_ai_success` - Tests successful AI response
  - `test_handle_ai_empty_response` - Tests handling of empty API responses
  - `test_handle_ai_api_error` - Tests API error handling
  - `test_handle_ai_with_callback` - Tests 5-second progress notification callback
  - `test_handle_ai_stream_message` - Tests AI command from stream messages
  - `test_execute_command_ai` - Tests AI command through execute_command interface
  - All 8 new AI tests pass successfully
  - Total test suite now has 62 passing tests (up from 54)

- **Integration tests for AI command** (`tests/test_integration.py`)
  - New `TestAICommand` test class with comprehensive integration tests
  - `test_ai_command_without_args` - Tests usage message when no prompt provided
  - `test_ai_command_simple_prompt_private` - Tests AI command in private messages
  - `test_ai_command_simple_prompt_stream` - Tests AI command in stream messages
  - `test_ai_command_response_time` - Tests AI responds within 20 seconds
  - `test_ai_command_multiple_words_prompt` - Tests multi-word prompts about technical topics
  - `test_ai_command_without_api_key_configured` - Tests error handling when API key is missing
  - Tests use `@pytest.mark.requires_anthropic` marker for conditional execution
  - Tests skip automatically if ANTHROPIC_API_KEY is not configured
  - Updated `run_integration_tests()` to include AI command test suite

- **Environment variable for AI functionality** (`src/bot.py`)
  - Added ANTHROPIC_API_KEY environment variable (optional)
  - If not set, AI command will return a helpful error message
  - Bot initializes anthropic client only when API key is available
  - Note: For production deployment, ANTHROPIC_API_KEY should be added to:
    - Kubernetes secrets in `chart/templates/secret.yaml`
    - Environment variables in `chart/templates/deployment.yaml`
    - Values configuration in `chart/values.yaml`

- **Nautobot integration** (`src/fetchers.py`, `src/commands.py`)
  - New `get_nautobot_devices()` function to query Nautobot API for device information
  - New `nautobot` command that accepts node names as arguments
  - Retrieves and displays device information including:
    - Device name with link to Nautobot
    - Rack information with link
    - Kubernetes version from custom fields
  - Supports querying multiple nodes in a single command
  - Comprehensive error handling for API requests (OSError, AttributeError, JSONDecodeError)
  - Uses `urllib3.PoolManager` for HTTP requests

- **Nautobot configuration** (`chart/templates/deployment.yaml`, `chart/templates/secret.yaml`, `chart/values.yaml`)
  - Added `NAUTOBOT_TOKEN` environment variable
  - Added `NAUTOBOT_URL` environment variable
  - New secret fields for Nautobot API credentials
  - Documented GitHub Matchbox token in values.yaml

- **Additional authorized user** (`src/bot.py`)
  - Added `manuvs@een.com` (without the dot)

### Changed

- **AI command implementation** (`src/commands.py`)
  - Removed placeholder message "AI command is not yet implemented. Coming soon!"
  - Replaced with full `handle_ai()` function implementation
  - Updated imports to include `threading` and `time` for progress notifications
  - Added try-except import block for anthropic package with graceful fallback

- **Message handling for AI command** (`src/bot.py`)
  - Modified `handle_message()` to detect AI command and pass `send_message` callback
  - Enables AI command to send progress notifications for long-running requests
  - Special handling allows AI command to provide better user experience with status updates

- **Makefile version bump**
  - Updated `IMAGE_TAG` from `v1.0.4` to `v1.1.0`
  - Modified release target to echo git commands instead of executing them (for safer releases)

- **Helm chart metadata** (`chart/Chart.yaml`)
  - Updated `appVersion` from `v1.0.4-05ebf72` to `v1.1.0-1e58eae`

- **Test suite enhancements** (`src/test_bot.py`)
  - Added comprehensive tests for Nautobot integration:
    - `test_get_nautobot_devices_success` - Tests successful device retrieval
    - `test_get_nautobot_devices_no_results` - Tests empty results handling
    - `test_get_nautobot_devices_with_missing_fields` - Tests handling of optional fields
    - `test_get_nautobot_devices_api_error` - Tests API error handling
    - `test_handle_nautobot_single_node` - Tests single node query
    - `test_handle_nautobot_multiple_nodes` - Tests multiple node queries
  - Updated all node command tests to mock HTTP requests properly
  - Added mock responses for Matchbox API calls in node tests
  - Added environment variable setup for `NAUTOBOT_TOKEN`, `NAUTOBOT_URL`, and `GITHUB_MATCHBOX_TOKEN`
  - Updated imports to include `json`, `Mock`, `handle_nautobot`, `get_nautobot_devices`, and `handle_node`
  - Fixed test expectations: changed "Useful system checks" to "Terminal one-liners"
  - Fixed kubectl command expectation: changed "kubectl events" to "kubectl get events"
  - All tests now properly mock external API calls

- **Test structure reorganization** (`tests/`, `Makefile`)
  - Created dedicated `./tests` directory for all test files
  - Moved `src/test_bot.py` to `tests/test_bot.py`
  - Moved `test_fetcher.py` to `tests/test_fetcher.py`
  - Updated test imports to add `src` to Python path for proper module resolution
  - Updated Makefile `test` target: changed from `cd src && python -m pytest test_bot.py -v` to `python -m pytest tests/ -v`
  - Updated Makefile `test-coverage` target: changed to `python -m pytest tests/ -v --cov=src --cov-report=term-missing`
  - All 52 tests pass successfully in new location

### Security

- **Removed hardcoded credentials from run.sh**
  - Removed exposed API keys and tokens (Zulip, GitHub, Nautobot) from `run.sh`
  - Updated `run.sh` to load credentials from `.env` file instead
  - Added `.env.example` template file with placeholder values for all required environment variables
  - Added `run.sh` to `.gitignore` to prevent future credential leaks
  - Note: Nautobot token was found in git history (commits db5cfd7, a8cf03a) and should be rotated

### Fixed

- **Node command error handling** (`src/nodes.py`, `tests/test_bot.py`)
  - Added comprehensive error handling for node lookup failures
  - **HTTP 404 errors**: Node not found in matchbox repository
    - Clear error message indicating node doesn't exist
    - Helpful suggestion to verify node name and try `nautobot` command
  - **HTTP 403 errors**: Access forbidden when querying matchbox
    - Error message about potential GitHub token issues
  - **Other HTTP errors**: Server errors (500, etc.)
    - Generic error message with specific HTTP status code
  - **JSON decode errors**: Corrupted or invalid response data
    - Error message indicating parse failure with context
  - **Unexpected exceptions**: Network errors and other failures
    - Catches all exceptions with detailed error messages
  - All error messages formatted with markdown for better readability in Zulip
  - Added 5 comprehensive test cases for error scenarios:
    - `test_handle_node_not_found_404`
    - `test_handle_node_access_forbidden_403`
    - `test_handle_node_http_error_500`
    - `test_handle_node_json_decode_error`
    - `test_handle_node_unexpected_exception`
  - Updated all existing node command tests to properly mock HTTP response status codes
  - All 67 unit tests now pass successfully (up from 62)

- **Integration test timeout handling** (`tests/test_integration.py`)
  - Fixed `send_and_wait()` method to accept optional `timeout` parameter
  - Resolves 4 failing AI command integration tests that required longer timeouts (15-20 seconds)
  - Tests affected:
    - `test_ai_command_simple_prompt_private`
    - `test_ai_command_simple_prompt_stream`
    - `test_ai_command_response_time`
    - `test_ai_command_multiple_words_prompt`
  - Default timeout remains MESSAGE_TIMEOUT (2 seconds) for backward compatibility
  - All 27 integration tests now pass successfully (6 skipped due to optional configuration)

- **Nautobot API error handling** (`src/fetchers.py`)
  - Fixed KeyError on missing `position` field: changed `device['position']` to `device.get('position', 'N/A')`
  - Fixed KeyError on missing rack `name` field: changed `data_rack['name']` to `data_rack.get('name', str(rack_id))`
  - Improved robustness when handling incomplete device data from Nautobot API

- **Nautobot command return value** (`src/commands.py`)
  - Fixed `handle_nautobot()` to return empty string when no devices found (previously returned "No devices found.")
  - Ensures consistent behavior with test expectations

- **1-on-1 PM test expectations** (`tests/test_bot.py`)
  - Updated `test_handle_message_one_on_one_pm_without_mention` to correctly expect bot responses in 1-on-1 conversations
  - Test now aligns with documented bot behavior: bot always responds in 1-on-1 PMs, even without explicit mention
  - All 54 unit tests now pass successfully

- **Private message mention detection** (`src/bot.py`, `tests/test_bot.py`)
  - Fixed critical bug where bot was responding to private messages without being mentioned
  - **Root cause**: Previous implementation parsed message content string for mentions and made repeated `client.get_profile()` API calls
  - **Solution**: Now uses Zulip's native `mentioned_user_ids` field for reliable mention detection
  - Bot profile is cached at startup (line 19, 172-177) instead of fetching on every message
  - Mention check now uses `mentioned_user_ids` list (line 116-121) for accurate detection
  - **Benefits**:
    - More reliable: Uses Zulip's official mention tracking system
    - More efficient: Eliminates repeated API calls for bot profile
    - Better debugging: Logs which user IDs were mentioned for troubleshooting
  - Updated all 5 private message tests to use `mentioned_user_ids` field:
    - `test_handle_message_authorized_user_private`
    - `test_handle_message_group_pm_with_mention`
    - `test_handle_message_group_pm_without_mention`
    - `test_handle_message_one_on_one_pm_with_mention`
    - `test_handle_message_one_on_one_pm_without_mention`
  - All 10 message handling tests pass successfully

- **Bug in command routing** (`src/commands.py`)
  - Fixed reference to non-existent `handle_ping()` function in line 164
  - Changed `ai` command to return placeholder message: "AI command is not yet implemented. Coming soon!"
  - Changed `mcp` command to return placeholder message: "MCP command is not yet implemented. Coming soon!"

## [v1.0.4] - 2025-10-26 (commit 7e5afb7)

### Added

- **Health check HTTP server** (`src/bot.py`)
  - New HTTP server running on port 8080 for Kubernetes health checks
  - `/healthz` endpoint for liveness probes
  - `/readyz` endpoint for readiness probes
  - Runs in a separate daemon thread to avoid blocking bot operations
  - Includes `HealthCheckHandler` class with suppressed logging to avoid cluttering logs

- **Kubernetes probes configuration** (`chart/templates/deployment.yaml`, `chart/values.yaml`)
  - Added `livenessProbe` configuration:
    - HTTP GET to `/healthz` on port 8080
    - 10s initial delay, 10s period, 5s timeout, 3 failure threshold
  - Added `readinessProbe` configuration:
    - HTTP GET to `/readyz` on port 8080
    - 5s initial delay, 5s period, 3s timeout, 3 failure threshold
  - Container port 8080 exposed for health checks

- **Additional authorized users** (`src/bot.py`)
  - Added `miniguez@een.com`
  - Added `jchio@een.com`
  - Added `mgolden@een.com`
  - Added `pwhiteside@een.com`

- **Comprehensive test coverage for health checks** (`src/test_bot.py`)
  - Tests for health server startup
  - Tests for `/healthz` endpoint (200 OK response)
  - Tests for `/readyz` endpoint (200 OK response)
  - Tests for invalid endpoints (404 response)

- **Enhanced node command tests** (`src/test_bot.py`)
  - Tests for single and multiple node names
  - Tests for node command without arguments
  - Tests for node command from stream messages
  - Tests for kubectl commands in output
  - Tests for all three Grafana dashboard links
  - Tests for journalctl SSH examples
  - Tests for special characters in node names
  - Tests for markdown formatting

### Changed

- **Image repository** (`Makefile`, `chart/values.yaml`)
  - Changed from `asajaroff/ritsuko` to `harbor.eencloud.com/test/ritsuko`
  - Updated push target in Makefile to use new repository

- **Helm chart metadata** (`chart/Chart.yaml`)
  - Updated chart version from `0.1.0` to `0.2.0`
  - Updated app version from `v1.0.4-733efa6` to `v1.0.4-7b85980`
  - Improved chart description: "A Helm chart for deploying Ritsuko in a Kubernetes cluster"

- **Help command output** (`src/commands.py`)
  - Reorganized command list with better categorization
  - Added placeholders for upcoming features (ai, mcp, jira, confluence)
  - Improved formatting with markdown code blocks
  - Added usage examples
  - Removed `ping` and `echo` commands from help text

- **Node command output** (`src/commands.py`)
  - Enhanced output structure with better markdown formatting
  - Moved Grafana links to the top for easier access
  - Updated kubectl events command syntax: `kubectl events --for node/{node} --context $KUBE_CLUSTER`
  - Added useful system checks section with multiple systemctl commands:
    - kubelet.service status
    - containerd.service status
    - docker.service status
  - Updated journalctl command to include `--no-follow` flag

- **Clusters command output** (`src/commands.py`)
  - Added link to VMS Global Uptime dashboard in header
  - Removed obsolete clusters (c000, c004, c005, c010)

- **Command routing** (`src/commands.py`)
  - Reordered match cases: help, ai, mcp, node, clusters, status, version
  - Removed `ping` and `echo` command handlers

- **Version command** (`src/commands.py`)
  - Updated default version string to include more context

### Removed

- **Removed `src/run.sh` script**
  - Shell script is no longer needed for local development

### Technical Improvements

- **Production readiness**: Health checks enable proper Kubernetes lifecycle management
- **Reliability**: Kubernetes probes can detect and restart unhealthy pods
- **Monitoring**: Dedicated health endpoints separate from application logic
- **Developer experience**: Enhanced command outputs with better structure and more useful information

- **Command parsing system** (`src/commands.py`)
  - New `parse_command()` function that intelligently parses commands based on message type:
    - Stream messages: extracts second word (first word after bot mention)
    - Private messages: extracts first word directly
  - New `execute_command()` function with match/case (Python 3.10+) switch statement for command routing
  - Built-in commands:
    - `help` - Display available commands
    - `ping` - Health check / bot responsiveness test
    - `status` - Show bot operational status
    - `echo <text>` - Echo back provided text
    - `version` - Display bot version information
  - Extensible command handler architecture for easy addition of new commands
  - Unknown command handling with helpful error messages

- **Command parsing tests** in `src/test_bot.py`
  - Tests for command parsing from stream messages
  - Tests for command parsing from private messages
  - Tests for all command handlers (help, ping, status, echo, version)
  - Tests for edge cases (empty messages, unknown commands, missing arguments)
  - Integration tests for command execution within message handling flow
  - Total of 20 passing tests covering all functionality

- **Comprehensive error handling throughout the bot**
  - Environment variable validation at startup (checks for `ZULIP_EMAIL`, `ZULIP_API_KEY`, `ZULIP_SITE`)
  - Try-except block around Zulip client initialization with proper error logging
  - New `send_message()` helper function that wraps all message sending with error handling
  - Exception handling in `handle_message()` for `KeyError` and general exceptions
  - Graceful shutdown handling for `KeyboardInterrupt` in main message loop
  - Proper exit codes for different failure scenarios

- **Unit test suite** (`src/test_bot.py`)
  - Tests for `send_message()` function:
    - Successful message sending
    - Failed message sending (Zulip API errors)
    - Exception handling (network errors, etc.)
  - Tests for `handle_message()` function:
    - Bot ignoring its own messages
    - Authorized user messages in private chats
    - Authorized user messages in streams
    - Unauthorized user messages in private chats
    - Unauthorized user messages in streams
    - Handling of messages with missing required fields
  - All tests use proper mocking to avoid requiring actual Zulip connections

- **Testing dependencies**
  - Added `pytest==8.3.4` to requirements.txt
  - Added `pytest-cov==6.0.0` to requirements.txt for coverage reporting

- **Makefile targets for testing**
  - `make test`: Runs the full test suite with verbose output
  - `make test-coverage`: Runs tests with coverage report showing line-by-line coverage

### Changed

- **Bot message handling** (`src/bot.py`)
  - Integrated command parsing system via `execute_command()` import
  - Bot now routes all authorized user messages through the command parser
  - Responses are now generated by command handlers instead of simple echo
  - Message handling tests updated to validate command execution flow

- Refactored all `client.send_message()` calls to use the new `send_message()` helper function
- Added docstrings to `send_message()` and `handle_message()` functions
- Enhanced logging messages with better error context
- Bot now logs "Starting Zulip bot..." message on startup for better visibility

### Removed

- Removed commented-out code (lines 40-47) that was no longer needed
  - Removed unused `original_content` variable
  - Removed unused `original_sender` variable
  - Removed placeholder code for `@followup` functionality

### Technical Improvements

- **Robustness**: Bot will now fail fast with clear error messages if misconfigured
- **Observability**: All errors are properly logged with context for easier debugging
- **Maintainability**: Centralized error handling makes future changes easier
- **Testability**: Comprehensive test coverage ensures reliability and makes refactoring safer
- **Production-ready**: Proper signal handling allows clean shutdowns in containerized environments

### Test Coverage

The test suite covers:
- Authorization logic (authorized vs unauthorized users)
- Message type handling (private vs stream messages)
- Error scenarios (missing fields, API failures, network errors)
- Bot self-message filtering
- Message response content verification

## Previous Changes

### [Initial Release]

- Basic Zulip bot functionality with message echoing
- Authorization based on hardcoded user list
- Support for both private messages and stream messages
- Environment-based configuration for Zulip credentials
- Docker containerization support
- Helm chart for Kubernetes deployment
- Makefile for common operations
